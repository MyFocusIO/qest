<div class="page-header">
  <h1>Topic: {{topic}}</h1>
</div>
<div class="row">
  <div class="span14">
    <form method="post">
      <fieldset>
        <div class="clearfix">
          <label for="payload">Content</label>
          <div class="input">
            <textarea id="payload" name="payload" class="xxlarge" rows="10" readonly>{{value.payload}}</textarea>
          </div>
        </div>
        <div class="actions">
          <input id="update" type="submit" class="btn success" value="Update"></input>
          <input id="edit" type="submit" class="btn primary" value="Edit"></input>
          <input id="cancel" type="submit" class="btn error" value="Cancel"></input>
        </div>
      </fieldset>
    </form>
  </div>
</div>

<script type="text/javascript" src="/socket.io/socket.io.js"></script>
<script type="text/javascript">
  socket = io.connect()

  var textarea = $("#payload");
  var update = $("#update");
  var edit = $("#edit");
  var cancel = $("#cancel");

  update.hide();
  cancel.hide();

  var last_data = null;
  socket.on("/topics/{{topic}}", function(data) {
    last_data = data;
    if(textarea.attr("readonly")) {
      textarea.val(data);
    }
  });

  update.click(function() {
    $.post("/topics/{{topic}}", { "_method": "put", payload: textarea.val() });
    textarea.attr("readonly", true);
    edit.toggle();
    update.toggle();
    cancel.toggle();
    return false;
  });

  edit.click(function() {
    textarea.removeAttr("readonly");
    update.toggle();
    cancel.toggle();
    edit.toggle();
    return false;
  });

  cancel.click(function() {
    textarea.val(last_data);
    textarea.attr("readonly", true);
    update.toggle();
    cancel.toggle();
    edit.toggle();
    return false;
  });
</script>
